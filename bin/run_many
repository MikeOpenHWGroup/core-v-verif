#! /bin/bash

# Copyright 2023, OpenHW Group
# SPDX-License-Identifier:Apache-2.0 WITH SHL-2.1

# Dead-simple script to run a single test multiple times and report pass/fail results.
# Uses a different seed for each run.
# Generates the same "make test" command generated by the "ci_check" script.
#
# Usage:   run_many [cfg] [test-program] [simulator] [nruns] [user_flags]
#          For example, "run_many pulp hello-world vcs 2" will run the hello-world
#          test-program with VCS twice, pulp configuration.
#
# TODO:    command-line argument processing is primitive.

if [ $# -gt 0 ]
then
  CFG=$1
else
  CFG=default
fi

if [ $# -gt 1 ]
then
  TESTPROGRAM=$2
else
  TESTPROGRAM=hello-world
fi

if [ $# -gt 2 ]
then
  SIM=$3
else
  SIM=vcs
fi

if [ $# -gt 3 ]
then
  RUNS=$4
else
  RUNS=2
fi
let RUNSM1=$RUNS-1

if [ $# -gt 4 ]
then
  USER_FLAGS=$5
else
  USER_FLAGS=
fi

if [[ -z "${CV_CORE}" ]];
then
  echo CV_CORE not defined... cannot proceed.
  exit 1
else
  cd ../${CV_CORE}/sim/uvmt
  echo "Running in ../${CV_CORE}/sim/uvmt"
fi

echo "IMPORTANT!!! Do you want to skip 'make clean_all' [Y/N]?"
read YORN
if [ $YORN != "Y" ];
then
  echo "make clean_all SIMULATOR=$SIM"
  make clean_all SIMULATOR=$SIM
fi

counter=0
until [ $counter -gt $RUNSM1 ]
do
  THISSEED=`date +%N`
  echo "make test CFG=$CFG TEST=$TESTPROGRAM SIMULATOR=$SIM GEN_START_INDEX=$counter RUN_INDEX=$counter USE_ISS=NO SEED=$THISSEED USER_RUN_FLAGS=$USER_FLAGS"
  make test CFG=$CFG TEST=$TESTPROGRAM SIMULATOR=$SIM GEN_START_INDEX=$counter RUN_INDEX=$counter USE_ISS=NO SEED=$THISSEED USER_RUN_FLAGS=$USER_FLAGS
  ((counter++))
done

echo $'\n'
echo "Summary:"
echo "  CORE-V Core:  $CV_CORE"
echo "  Test-Program: $TESTPROGRAM"
echo "  Simulator:    $SIM"
if [ -d "${SIM}_results" ];
then
  echo -n "  Number of tests run:    "
  grep "SIMULATION" `find ${SIM}_results/$CFG/$TESTPROGRAM -name ${SIM}-*` | wc -l
  echo -n "  Number of tests FAILED: "
  grep "SIMULATION FAILED" `find ${SIM}_results/$CFG/$TESTPROGRAM -name ${SIM}-*` | wc -l
  echo
else
  echo -e '\nNo tests found.\n'
fi
